name: Build and Push Images (ArgoCD GitOps)

on:
  push:
    branches: [ main ]
    paths:
      - 'app/**'
      - 'k8s/**'
      - '.github/workflows/gitops-build.yaml'
  workflow_dispatch:

env:
  REGISTRY: docker.io
  API_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/production-platform-api
  WORKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/production-platform-worker

jobs:
  # ===== 1. Quality Gate =====
  quality:
    name: ðŸ§ª Quality Gate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Run Tests - API
      working-directory: ./app/api-service
      run: go test -v ./...
    
    - name: Run Tests - Worker
      working-directory: ./app/worker-service
      run: go test -v ./...

  # ===== 2. Build & Push Docker Images =====
  build:
    name: ðŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: quality
    outputs:
      image-tag: ${{ steps.image-tag.outputs.tag }}
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Generate Image Tag
      id: image-tag
      run: |
        # Use short SHA for image tag
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "tag=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "Using image tag: $SHORT_SHA"
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push API
      uses: docker/build-push-action@v5
      with:
        context: ./app/api-service
        push: true
        tags: |
          ${{ env.API_IMAGE }}:${{ steps.image-tag.outputs.tag }}
          ${{ env.API_IMAGE }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Build and push Worker
      uses: docker/build-push-action@v5
      with:
        context: ./app/worker-service
        push: true
        tags: |
          ${{ env.WORKER_IMAGE }}:${{ steps.image-tag.outputs.tag }}
          ${{ env.WORKER_IMAGE }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ===== 3. Update Kustomization (GitOps) =====
  update-manifests:
    name: ðŸ“ Update Image Tags
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update kustomization.yaml
      run: |
        cd k8s/overlays/prod
        
        # Update image tags in kustomization.yaml
        sed -i "/name: .*production-platform-api/,/newTag:/ s/newTag:.*/newTag: ${{ needs.build.outputs.image-tag }}/" kustomization.yaml
        sed -i "/name: .*production-platform-worker/,/newTag:/ s/newTag:.*/newTag: ${{ needs.build.outputs.image-tag }}/" kustomization.yaml
        
        echo "Updated kustomization.yaml:"
        cat kustomization.yaml
    
    - name: Commit and Push Changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add k8s/overlays/prod/kustomization.yaml
        
        # Only commit if there are changes
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸš€ Update image tags to ${{ needs.build.outputs.image-tag }}"
          git push
        fi
    
    - name: Deployment Summary
      run: |
        echo "## âœ… Images Built & Manifest Updated!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Built Images:**" >> $GITHUB_STEP_SUMMARY
        echo "- API: \`${{ env.API_IMAGE }}:${{ needs.build.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Worker: \`${{ env.WORKER_IMAGE }}:${{ needs.build.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**GitOps Flow:**" >> $GITHUB_STEP_SUMMARY
        echo "1. âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
        echo "2. âœ… Images built and pushed to Docker Hub" >> $GITHUB_STEP_SUMMARY
        echo "3. âœ… Kustomization updated with new image tags" >> $GITHUB_STEP_SUMMARY
        echo "4. â³ ArgoCD will detect changes and deploy automatically" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Monitor Deployment:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "kubectl get application production-platform -n argocd" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
