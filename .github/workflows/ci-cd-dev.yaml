name: Production Platform CI/CD

on:
  push:
    branches: [ main ]

env:
  REGISTRY: docker.io
  API_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/production-platform-api
  WORKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/production-platform-worker

jobs:
  # ===== 1. Quality Gate =====
  quality:
    name: ðŸ§ª Quality Gate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Run Tests
      run: |
        cd app/api-service && go test -v ./...
        cd ../worker-service && go test -v ./...
    
      

  # ===== 2. Build & Push =====
  build:
    name: ðŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: quality
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push API
      uses: docker/build-push-action@v5
      with:
        context: ./app/api-service
        push: true
        tags: |
          ${{ env.API_IMAGE }}:${{ github.sha }}
          ${{ env.API_IMAGE }}:latest
    
    - name: Build and push Worker
      uses: docker/build-push-action@v5
      with:
        context: ./app/worker-service
        push: true
        tags: |
          ${{ env.WORKER_IMAGE }}:${{ github.sha }}
          ${{ env.WORKER_IMAGE }}:latest

  # ===== 3. Deploy to Kind (Kubernetes in Docker) =====
  deploy-test:
    name: ðŸš€ Deploy & Test
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Kind Cluster
      run: |
        # Install Kind (lightweight Kubernetes in Docker)
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        
        # Create Kind configuration
        cat > kind-config.yaml <<EOF
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          extraPortMappings:
          - containerPort: 30000
            hostPort: 30000
            protocol: TCP
        EOF
        
        # Create cluster
        kind create cluster --name production-platform --config kind-config.yaml
        
        # Verify
        kubectl cluster-info
        kubectl get nodes
    
    - name: Deploy to Kind
      run: |
        # Create namespace
        kubectl create namespace production-platform --dry-run=client -o yaml | kubectl apply -f -
        
        # Apply all manifests
        echo "ðŸ“¦ Deploying Kubernetes manifests..."
        kubectl apply -f k8s/base/ -n production-platform
        
        # Wait for Redis (StatefulSet takes time)
        kubectl rollout status statefulset/redis -n production-platform --timeout=120s
        
        # Update to newly built images
        kubectl set image deployment/api \
          api=${{ env.API_IMAGE }}:${{ github.sha }} \
          -n production-platform
        
        kubectl set image deployment/worker \
          worker=${{ env.WORKER_IMAGE }}:${{ github.sha }} \
          -n production-platform
        
        # Wait for rollouts
        kubectl rollout status deployment/api -n production-platform --timeout=120s
        kubectl rollout status deployment/worker -n production-platform --timeout=120s
    
    - name: Test Deployment
      run: |
        echo "ðŸ§ª Testing deployment..."
        
        # Test API
        kubectl run test-curl --rm -i --restart=Never \
          --image=curlimages/curl:latest \
          --namespace=production-platform \
          -- curl -f http://api/health
        
        echo "âœ… API is healthy!"
        
        # Show deployment status
        echo ""
        echo "ðŸ“Š Deployment Status:"
        kubectl get all -n production-platform
        
        echo ""
        echo "ðŸ“ˆ HPA Status:"
        kubectl get hpa -n production-platform
        
        echo ""
        echo "ðŸ›¡ï¸ PDB Status:"
        kubectl get pdb -n production-platform
    
    - name: Cleanup
      if: always()
      run: |
        # Delete Kind cluster
        kind delete cluster --name production-platform